name: Deploy

on:
  workflow_dispatch:
    inputs:
      target:
        description: 'Deployment target'
        required: true
        type: choice
        options:
          - arasaka
          - esoteric
          - all
  # Auto-deploy after successful builds on main
  workflow_run:
    workflows:
      - "NixOS Build Check"
      - "Darwin Build Check"
    types:
      - completed
    branches:
      - main

env:
  ARASAKA_IP: "100.64.0.0"
  ESOTERIC_IP: "100.64.0.1"

jobs:
  # =============================================================================
  # DEPLOY TO NIXOS (ARASAKA)
  # =============================================================================
  deploy-arasaka:
    if: |
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.target == 'arasaka' || github.event.inputs.target == 'all')) ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.name == 'NixOS Build Check' && github.event.workflow_run.conclusion == 'success')
    runs-on: ubuntu-latest

    steps:
      - name: Setup Tailscale
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TAILSCALE_AUTH_KEY }}

      - name: Wait for Tailscale connection
        run: |
          echo "Waiting for Tailscale to connect..."
          for i in {1..30}; do
            if tailscale status | grep -q "${{ env.ARASAKA_IP }}"; then
              echo "Tailscale connected, can see arasaka"
              break
            fi
            echo "Attempt $i/30: Waiting for Tailscale..."
            sleep 2
          done
          tailscale status

      - name: Wait for Tailscale SSH
        run: |
          echo "Waiting for Tailscale SSH to be ready..."
          for i in {1..30}; do
            if tailscale status | grep -q "arasaka"; then
              echo "Can see arasaka in Tailscale network"
              tailscale status
              break
            fi
            echo "Attempt $i/30: Waiting..."
            sleep 2
          done

      - name: Deploy to arasaka
        run: |
          # Deploy using Tailscale SSH (uses machine name, not IP)
          tailscale ssh --accept-risk=lose-ssh infktd@arasaka << 'EOF'
            cd ~/.config/asthenia
            git pull
            sudo nixos-rebuild switch --flake .#arasaka
            home-manager switch --flake .#niri
          EOF

      - name: Deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ Successfully deployed to arasaka"
          else
            echo "❌ Deployment to arasaka failed"
          fi

  # =============================================================================
  # DEPLOY TO DARWIN (ESOTERIC)
  # =============================================================================
  deploy-esoteric:
    if: |
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.target == 'esoteric' || github.event.inputs.target == 'all')) ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.name == 'Darwin Build Check' && github.event.workflow_run.conclusion == 'success')
    runs-on: ubuntu-latest

    steps:
      - name: Setup Tailscale
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TAILSCALE_AUTH_KEY }}

      - name: Wait for Tailscale SSH
        run: |
          echo "Waiting for Tailscale SSH to be ready..."
          for i in {1..30}; do
            if tailscale status | grep -q "esoteric"; then
              echo "Can see esoteric in Tailscale network"
              tailscale status
              break
            fi
            echo "Attempt $i/30: Waiting..."
            sleep 2
          done

      - name: Deploy to esoteric
        run: |
          # Deploy using Tailscale SSH (uses machine name, not IP)
          tailscale ssh --accept-risk=lose-ssh jayne@esoteric << 'EOF'
            cd ~/.config/asthenia
            git pull
            darwin-rebuild switch --flake .#esoteric
            home-manager switch --flake .#aerospace
          EOF

      - name: Deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ Successfully deployed to esoteric"
          else
            echo "❌ Deployment to esoteric failed"
          fi
